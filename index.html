<!doctype html>
<html lang="so">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BAXNAANO PHARMACY - SECURE SYSTEM (Fixed)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root{--accent:#0d9fff;--accent-dark:#0078d4;--danger:#e23b3b;--muted:#6c757d;--success:#00ac69;--warning:#f4a100;}
  body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#222; font-family:Inter,Segoe UI,Roboto,Arial,sans-serif; margin:0; padding:0; min-height:100vh;}
  .login-container{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;}
  .glass-card{background:rgba(255,255,255,0.12); backdrop-filter:blur(10px); border-radius:1rem; padding:2rem; width:100%; max-width:460px; box-shadow:0 8px 32px rgba(0,0,0,0.25);}
  .nav-top-bar{background:rgba(255,255,255,0.06); padding:1rem; position:sticky; top:0; z-index:1000;}
  .nav-links{display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:center; margin-top:0.5rem;}
  .navlink{color:rgba(255,255,255,0.95); text-decoration:none; padding:0.5rem 1rem; border-radius:6px; display:inline-flex; align-items:center; gap:0.5rem;}
  .navlink.active{background:var(--accent); color:#fff; font-weight:600;}
  .content-area{max-width:1400px; margin:0 auto; padding:1.5rem;}
  .unified-section{background:#fff; border-radius:1rem; box-shadow:0 8px 32px rgba(0,0,0,0.08); padding:1.5rem; margin-bottom:1.5rem;}
  .stat-card{padding:1.5rem; border-radius:10px; background:linear-gradient(145deg,#fff,#f8f9fa); box-shadow:0 6px 20px rgba(20,20,20,0.04); text-align:center; height:100%;}
  .stat-value{font-size:1.6rem; font-weight:700; color:var(--accent); margin:0.5rem 0;}
  .admin-only{display:none!important;}
  .is-admin .admin-only{display:block!important;}
  .low-badge{background:var(--warning); color:#000; padding:0.25rem 0.5rem; border-radius:0.4rem; font-weight:600; font-size:0.75rem;}
  .expiry-danger{color:var(--danger); font-weight:700;}
  .receipt{font-family:Courier,monospace; background:#fff; padding:16px; border-radius:8px; max-width:320px; margin:auto;}
  .btn-accent{background:var(--accent); color:#fff; border:none; border-radius:8px; padding:8px 16px; font-weight:600;}
  .btn-accent:hover{background:var(--accent-dark)}
  .form-control, .form-select{border-radius:8px; border:1px solid #ddd;}
  @media print{body *{visibility:hidden} #printArea, #printArea *{visibility:visible}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView" class="login-container" aria-hidden="false">
  <div class="glass-card">
    <div class="text-center mb-4">
      <i class="bi bi-shield-lock" style="font-size:3rem;color:white;"></i>
      <h4 class="text-white mt-3">BAXNAANO PHARMACY</h4>
      <p class="text-white-50 mb-0">Secure Management System</p>
    </div>
    <form id="loginForm" autocomplete="on">
      <div class="mb-3">
        <label class="form-label text-white">Username</label>
        <input id="loginUser" class="form-control" autocomplete="username" required autofocus>
      </div>
      <div class="mb-3">
        <label class="form-label text-white">Password</label>
        <input id="loginPass" type="password" class="form-control" autocomplete="current-password" required>
      </div>
      <div class="d-grid gap-2">
        <button type="submit" class="btn-accent w-100"><i class="bi bi-box-arrow-in-right"></i> Login</button>
        <button type="button" id="firstSetupBtn" class="btn btn-outline-light" style="display:none;">First time setup</button>
      </div>
    </form>
    <div class="text-center mt-3"><small class="text-white-50">Contact administrator for access</small></div>
  </div>
</div>

<!-- MAIN APP (hidden by default) -->
<div id="mainView" class="main-container" style="display:none;">
  <div class="nav-top-bar">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <div>
        <h5 class="text-white mb-0"><i class="bi bi-capsule"></i> BAXNAANO PHARMACY</h5>
        <small class="text-white-50">Secure System v2.1</small>
      </div>
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <div style="background:rgba(13,159,255,0.1); padding:0.5rem 1rem; border-radius:6px;">
          <span class="text-white">User: <b id="currentUser">-</b></span>
          <span class="text-white-50">(<span id="currentRole">-</span>)</span>
        </div>
        <button class="btn btn-outline-light btn-sm" onclick="backupData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
      </div>
    </div>
    <div class="nav-links">
      <a href="#" data-target="dashboard" class="navlink active"><i class="bi bi-speedometer2"></i> Dashboard</a>
      <a href="#" data-target="sell" class="navlink"><i class="bi bi-receipt"></i> Sell (POS)</a>
      <a href="#" data-target="products" class="navlink admin-only"><i class="bi bi-pills"></i> Products</a>
      <a href="#" data-target="reports" class="navlink"><i class="bi bi-graph-up"></i> Reports</a>
      <a href="#" data-target="returns" class="navlink admin-only"><i class="bi bi-arrow-return-left"></i> Returns</a>
      <a href="#" data-target="users" class="navlink admin-only"><i class="bi bi-people"></i> Users</a>
      <a href="#" data-target="credit" class="navlink"><i class="bi bi-credit-card"></i> Credit</a>
    </div>
  </div>

  <div class="content-area">
    <div id="emergencyReset" class="unified-section admin-only" style="display:none;">
      <h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> Emergency Data Reset</h6>
      <button class="btn btn-danger" onclick="confirmReset()"><i class="bi bi-trash-fill"></i> Reset All Data</button>
    </div>

    <div id="dashboardView" class="unified-section">
      <h6 class="mb-3"><i class="bi bi-speedometer2"></i> Dashboard Overview</h6>
      <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3"><div class="stat-card"><small class="text-muted">Today's Sales</small><div class="stat-value" id="statToday">$0.00</div></div></div>
        <div class="col-md-6 col-lg-3"><div class="stat-card"><small class="text-muted">This Week</small><div class="stat-value" id="statWeek">$0.00</div></div></div>
        <div class="col-md-6 col-lg-3"><div class="stat-card"><small class="text-muted">This Month</small><div class="stat-value" id="statMonth">$0.00</div></div></div>
        <div class="col-md-6 col-lg-3"><div class="stat-card"><small class="text-muted">Total Profit</small><div class="stat-value" id="statProfit">$0.00</div></div></div>
      </div>
      <div class="row g-3">
        <div class="col-lg-8"><div class="unified-section"><h6><i class="bi bi-graph-up"></i> Sales Chart (Last 14 Days)</h6><canvas id="chartSales" style="max-height:250px;"></canvas></div></div>
        <div class="col-lg-4"><div class="unified-section"><h6><i class="bi bi-trophy"></i> Top Sold Items</h6><div id="topSoldList"></div></div></div>
      </div>
      <div class="unified-section mt-3"><h6><i class="bi bi-exclamation-triangle"></i> Stock & Expiry Alerts</h6><div id="lowStockAlerts"></div></div>
    </div>

    <div id="sellView" class="unified-section" style="display:none;">
      <h6 class="mb-3"><i class="bi bi-receipt"></i> Point of Sale</h6>
      <div class="row g-3">
        <div class="col-lg-6">
          <input id="searchProduct" class="form-control mb-3" placeholder="üîç Search product by name...">
          <div class="table-responsive" id="productList"></div>
        </div>
        <div class="col-lg-6">
          <h6>üõí Shopping Cart</h6><div id="cartArea"></div>
          <div class="d-flex gap-2 mt-3 flex-wrap align-items-end">
            <select id="payType" class="form-select" style="max-width:150px;"><option value="Paid">üíµ Paid</option><option value="Credit">üí≥ Credit</option></select>
            <input id="custName" class="form-control" placeholder="Customer Name" style="display:none; max-width:200px;" autocomplete="name">
            <input id="custPhone" class="form-control" placeholder="Phone Number" style="display:none; max-width:200px;" autocomplete="tel">
            <button class="btn-accent ms-auto" id="btnSaveSale"><i class="bi bi-printer"></i> Save & Print</button>
          </div>
        </div>
      </div>
    </div>

    <div id="productsView" class="unified-section admin-only" style="display:none;">
      <h6 class="mb-3"><i class="bi bi-pills"></i> Manage Products</h6>
      <form id="productForm" class="row g-2 mb-3">
        <input type="hidden" id="editProductId">
        <div class="col-md-6 col-lg-3"><input id="pName" class="form-control" placeholder="Medicine Name" required maxlength="100"></div>
        <div class="col-md-6 col-lg-2"><input id="pPrice" class="form-control" type="number" min="0.01" step="0.01" placeholder="Sale Price $" required></div>
        <div class="col-md-6 col-lg-2"><input id="pCost" class="form-control" type="number" min="0.01" step="0.01" placeholder="Cost Price $" required></div>
        <div class="col-md-6 col-lg-1"><input id="pQty" class="form-control" type="number" min="0" placeholder="Qty" required></div>
        <div class="col-md-6 col-lg-1"><input id="pLow" class="form-control" type="number" min="0" placeholder="Low Alert" value="5" required></div>
        <div class="col-md-6 col-lg-2"><input id="pExpiry" class="form-control" type="date" required></div>
        <div class="col-md-6 col-lg-1"><button type="submit" class="btn-accent w-100">Save</button></div>
      </form>
      <input id="filterProd" class="form-control mb-3" placeholder="üîç Filter products...">
      <div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Name</th><th>Price</th><th>Cost</th><th>Qty</th><th>Low</th><th>Expiry</th><th width="100">Action</th></tr></thead><tbody id="productsTable"></tbody></table></div>
    </div>

    <div id="reportsView" class="unified-section" style="display:none;">
      <h6 class="mb-3"><i class="bi bi-graph-up"></i> Sales Reports</h6>
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="d-flex gap-2 align-items-center mb-3 flex-wrap">
            <label class="form-label mb-0">üìÖ Range:</label>
            <select id="reportRange" class="form-select" style="max-width:150px;"><option value="today">Today</option><option value="week">Week</option><option value="month">Month</option><option value="all">All</option><option value="custom">Custom</option></select>
            <input type="date" id="rFrom" class="form-control" style="display:none; max-width:150px;">
            <input type="date" id="rTo" class="form-control" style="display:none; max-width:150px;">
          </div>
          <div class="card-modern"><h4 class="text-success" id="repTotal">$0.00</h4><div class="text-muted">Total sales in selected range</div></div>
          <div class="mt-3"><h6>üì¶ Items Sold Breakdown</h6><div id="repItems"></div></div>
        </div>
        <div class="col-lg-6">
          <h6>üõí Recent Sales</h6><div class="table-responsive"><table class="table table-sm table-hover"><thead class="table-light"><tr><th>ID</th><th>Date</th><th>Total</th><th>Type</th><th>User</th></tr></thead><tbody id="recentSalesTbl"></tbody></table></div>
          <hr><h6>üí≥ Credit Accounts</h6><div id="creditList"></div>
        </div>
      </div>
    </div>

    <div id="returnsView" class="unified-section admin-only" style="display:none;">
      <h6 class="mb-3"><i class="bi bi-arrow-return-left"></i> Process Returns (Admin Only)</h6>
      <div class="card-modern">
        <div class="d-flex gap-2 mb-3 flex-wrap">
          <input id="returnOrderId" class="form-control" placeholder="Enter Order ID (e.g., INV_...)" style="max-width:300px;">
          <button class="btn-accent" onclick="processReturn(document.getElementById('returnOrderId').value)"><i class="bi bi-check-circle"></i> Process Return</button>
        </div>
        <div id="returnResult"></div>
      </div>
      <h6 class="mt-4">üìú Returns History</h6><div id="returnsList" class="table-responsive"></div>
    </div>

    <div id="usersView" class="unified-section admin-only" style="display:none;">
      <h6 class="mb-3"><i class="bi bi-people"></i> Manage Users</h6>
      <form id="userForm" class="row g-2 mb-3">
        <div class="col-md-4"><input id="uName" class="form-control" placeholder="Username" required maxlength="50"></div>
        <div class="col-md-4"><input id="uPass" class="form-control" type="password" placeholder="Password" required minlength="4"></div>
        <div class="col-md-4"><select id="uRole" class="form-select"><option value="cashier">Cashier</option><option value="admin">Admin</option></select></div>
        <div class="col-12"><button type="submit" class="btn-accent">‚ûï Add User</button></div>
      </form>
      <div class="table-responsive"><table class="table table-sm table-hover"><thead class="table-light"><tr><th>Username</th><th>Role</th><th width="100">Action</th></tr></thead><tbody id="usersTable"></tbody></table></div>
    </div>

    <div id="creditView" class="unified-section" style="display:none;">
      <h6 class="mb-3"><i class="bi bi-credit-card"></i> Credit Payments</h6>
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="credit-payment-section">
            <h6>üí∞ Record Payment</h6>
            <form id="creditPaymentForm">
              <div class="mb-3"><input id="searchCustomer" class="form-control" placeholder="üîç Search customer by name or phone..." required></div>
              <div class="mb-3"><input id="paymentAmount" class="form-control" type="number" min="0.01" step="0.01" placeholder="Payment Amount $" required></div>
              <div class="mb-3"><input id="paymentNote" class="form-control" placeholder="Note (optional)"></div>
              <button type="submit" class="btn-accent w-100"><i class="bi bi-credit-card"></i> Record Payment</button>
            </form>
          </div>
          <div id="paymentResult" class="mt-3"></div>
        </div>
        <div class="col-lg-6">
          <h6>üë• Customer Credit Accounts</h6><div id="creditAccountsList" class="table-responsive"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="printArea" style="display:none;"><div class="receipt" id="printContent"></div></div>

<script>
/* ================== Utilities & Storage Keys ================== */
const K_PROD = 'bx_pharmacy_products_v3', K_SALES = 'bx_pharmacy_sales_v3', K_USERS = 'bx_pharmacy_users_v3';
const K_RETURNS = 'bx_pharmacy_returns_v3', K_PATIENTS = 'bx_pharmacy_patients_v3', K_PAYMENTS = 'bx_pharmacy_payments_v3';

function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch(e){console.error(e); return []; } }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); return true;}catch(e){console.error(e); return false; } }
function uid(pref='id'){ return pref + '_' + Date.now() + '_' + Math.floor(Math.random()*9000+1000); }
function fmt(n){ return '$' + Number(n||0).toFixed(2); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Local date utils (use client local timezone) */
function toLocalYYYYMMDD(d){
  const dt = new Date(d);
  const tz = dt.getTimezoneOffset()*60000;
  const local = new Date(dt - tz);
  return local.toISOString().split('T')[0];
}
function getTodayString(){ return toLocalYYYYMMDD(new Date()); }
function startOfLocalDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function endOfLocalDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
function isExpiredLocal(dateStr){ try{ if(!dateStr) return false; const exp = new Date(dateStr + 'T23:59:59'); const today = startOfLocalDay(new Date()); return exp < today; }catch(e){ return false; }}

/* SHA-256 hashing for passwords (Web Crypto) */
async function sha256hex(message){
  const enc = new TextEncoder(); const msgUint8 = enc.encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* Toast */
function showToast(icon, title, timer=2000){ Swal.fire({ icon, title, timer, toast:true, position:'top-end', showConfirmButton:false }); }

/* Backup */
function backupData(){
  const data = { products:load(K_PROD), sales:load(K_SALES), users:load(K_USERS), returns:load(K_RETURNS), patients:load(K_PATIENTS), payments:load(K_PAYMENTS), timestamp:new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `pharmacy-backup-${getTodayString()}.json`; a.click(); URL.revokeObjectURL(a.href);
  showToast('success','Backup downloaded');
}

/* Reset */
function confirmReset(){ Swal.fire({ title:'‚ö†Ô∏è DELETE ALL DATA?', text:'Cannot be undone!', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>{ if(r.isConfirmed){ localStorage.clear(); sessionStorage.clear(); location.reload(); } }); }

/* ================== AUTH & FIRST-TIME SETUP ================== */
let currentUser = null, cart = [];

async function firstTimeSetupModal(){
  const { value: formValues } = await Swal.fire({
    title: 'First Time Setup - Create Admin',
    html:
      '<input id="fti_user" class="swal2-input" placeholder="Admin username">' +
      '<input id="fti_pass" type="password" class="swal2-input" placeholder="Admin password (min 4)">' ,
    focusConfirm: false,
    showCancelButton: false,
    preConfirm: async () => {
      const u = document.getElementById('fti_user').value.trim();
      const p = document.getElementById('fti_pass').value;
      if(!u || p.length < 4){ Swal.showValidationMessage('Enter username and password (>=4 chars)'); return false; }
      const hash = await sha256hex(p);
      const users = load(K_USERS);
      users.push({ username: u, passwordHash: hash, role: 'admin', created: new Date().toISOString() });
      save(K_USERS, users);
      return { u, hash };
    }
  });
  if(formValues !== false){
    // auto-login the new admin
    const users = load(K_USERS), u = users[users.length-1];
    sessionStorage.setItem('pharmacy_user', u.username);
    currentUser = u;
    showAppForUser(u);
    showToast('success','Admin created & logged in');
  }
}

/* Show app with role applied */
function showAppForUser(user){
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('mainView').style.display = 'block';
  document.getElementById('currentUser').textContent = user.username;
  document.getElementById('currentRole').textContent = user.role;
  if(user.role === 'admin'){ document.body.classList.add('is-admin'); document.getElementById('emergencyReset').style.display = ''; } else { document.body.classList.remove('is-admin'); document.getElementById('emergencyReset').style.display = 'none'; }
  initUI(); updateDashboard(); showAlerts();
}

/* Login form */
document.getElementById('loginForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  if(!username || !password){ Swal.fire('Error','Enter credentials','error'); return; }
  const users = load(K_USERS);
  const hash = await sha256hex(password);
  const user = users.find(u => u.username === username && u.passwordHash === hash);
  if(!user){ Swal.fire('Login Failed','Invalid credentials','error'); return; }
  sessionStorage.setItem('pharmacy_user', user.username);
  currentUser = user;
  showAppForUser(user);
});

/* Logout */
function logout(){ sessionStorage.removeItem('pharmacy_user'); location.reload(); }

/* On load: if no users -> show first-time setup button on login */
window.addEventListener('load', ()=>{
  const users = load(K_USERS);
  if(!users.length){
    // show setup button
    document.getElementById('firstSetupBtn').style.display = 'block';
    document.getElementById('firstSetupBtn').addEventListener('click', firstTimeSetupModal);
    // also auto-open modal
    setTimeout(firstTimeSetupModal, 250);
  } else {
    // check session
    const su = sessionStorage.getItem('pharmacy_user');
    if(su){
      const user = users.find(u => u.username === su);
      if(user){ currentUser = user; showAppForUser(user); } else { sessionStorage.removeItem('pharmacy_user'); }
    }
  }
});

/* ================== NAVIGATION ================== */
document.querySelectorAll('.navlink').forEach(link=>{
  link.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.navlink').forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('[id$="View"]').forEach(v=>v.style.display='none');
    const target = document.getElementById(link.dataset.target + 'View');
    target.style.display = '';
    const t = link.dataset.target;
    if(t==='products') renderProducts();
    if(t==='sell') renderSell();
    if(t==='reports') renderReports();
    if(t==='users') renderUsers();
    if(t==='returns') renderReturnsHistory();
    if(t==='credit') renderCreditView();
    if(t==='dashboard') updateDashboard();
  });
});

/* ================== DASHBOARD & STATS ================== */

/* Use local date (YYYY-MM-DD) for grouping & comparisons */
function calcSales(range){
  const sales = load(K_SALES);
  const today = getTodayString();
  if(range === 'today'){
    return sales.filter(s => toLocalYYYYMMDD(new Date(s.date)) === today && !s.returned).reduce((sum,s)=>sum + Number(s.total), 0);
  } else if(range === 'week'){
    const base = new Date(); base.setDate(base.getDate() - 7);
    return sales.filter(s => !s.returned && new Date(s.date) >= base).reduce((sum,s)=>sum + Number(s.total),0);
  } else if(range === 'month'){
    const base = new Date(); base.setDate(1);
    return sales.filter(s => !s.returned && new Date(s.date) >= base).reduce((sum,s)=>sum + Number(s.total),0);
  }
  return 0;
}

function calcProfit(){
  return load(K_SALES).filter(s => !s.returned).reduce((total, sale) => total + sale.lines.reduce((sum, line) => sum + Math.max(0, (line.price - line.cost) * line.qty), 0), 0);
}

function updateDashboard(){
  document.getElementById('statToday').textContent = fmt(calcSales('today'));
  document.getElementById('statWeek').textContent = fmt(calcSales('week'));
  document.getElementById('statMonth').textContent = fmt(calcSales('month'));
  document.getElementById('statProfit').textContent = fmt(calcProfit());
  renderTopSold(); renderChart(); renderLowStockAlerts();
}

function renderTopSold(){
  const sold = {};
  load(K_SALES).filter(s => !s.returned).forEach(s => s.lines.forEach(l => sold[l.name] = (sold[l.name]||0) + l.qty));
  const sorted = Object.entries(sold).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const container = document.getElementById('topSoldList');
  container.innerHTML = sorted.length ? `<ul class="list-group">${sorted.map(([n,q])=>`<li class="list-group-item d-flex justify-content-between">${escapeHtml(n)}<span class="badge bg-primary rounded-pill">${q}</span></li>`).join('')}</ul>` : '<div class="empty-state">No sales yet</div>';
}

/* Simple chart drawing (kept lightweight) */
function renderChart(){
  const canvas = document.getElementById('chartSales');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const rectW = canvas.clientWidth; const rectH = 220;
  canvas.width = rectW; canvas.height = rectH;
  ctx.clearRect(0,0,rectW,rectH);
  const days = 14, labels = [], totals = [];
  for(let i = days - 1; i >= 0; i--){
    const d = new Date(); d.setDate(d.getDate() - i);
    labels.push(toLocalYYYYMMDD(d));
  }
  labels.forEach(date => totals.push(load(K_SALES).filter(s => toLocalYYYYMMDD(new Date(s.date)) === date && !s.returned).reduce((sum,s)=>sum + Number(s.total),0)));
  const max = Math.max(...totals,1), padding = 30, barWidth = (rectW - padding*2)/days;
  totals.forEach((v,i)=>{ const h = (v/max) * (rectH - 60); const x = padding + i*barWidth + 6; const y = rectH - padding - h; ctx.fillStyle='rgba(13,159,255,0.7)'; ctx.fillRect(x,y,barWidth-12,h); });
  ctx.fillStyle='#0d9fff'; ctx.font='11px Inter'; ctx.textAlign='center';
  labels.forEach((l,i)=>{ if(i%2===0) ctx.fillText(l.slice(5), padding + i*barWidth + barWidth/2, rectH - 8); });
}

function renderLowStockAlerts(){
  const products = load(K_PROD), low = products.filter(p => p.qty <= p.low && p.qty >= 0), exp = products.filter(p => isExpiredLocal(p.expiry));
  const container = document.getElementById('lowStockAlerts');
  let html = '';
  if(low.length) html += `<h6 class="text-warning">‚ö†Ô∏è Low Stock Alerts</h6><ul class="list-group mb-3">${low.map(p=>`<li class="list-group-item d-flex justify-content-between">${escapeHtml(p.name)}<span class="low-badge">Qty: ${p.qty}</span></li>`).join('')}</ul>`;
  if(exp.length) html += `<h6 class="text-danger">üö® Expired Drugs</h6><ul class="list-group">${exp.map(p=>`<li class="list-group-item d-flex justify-content-between text-danger">${escapeHtml(p.name)}<span>${p.expiry}</span></li>`).join('')}</ul>`;
  if(!low.length && !exp.length) html = '<div class="empty-state">‚úÖ All stock is healthy</div>';
  container.innerHTML = html;
}

function showAlerts(){
  const products = load(K_PROD), low = products.filter(p=>p.qty <= p.low && p.qty >= 0), exp = products.filter(p=>isExpiredLocal(p.expiry));
  if(low.length || exp.length){
    Swal.fire({ icon:'warning', title:'Stock Alert', html:`${low.length?`üì¶ Low: ${low.map(p=>`${p.name} (${p.qty})`).join(', ')}<br>`:''}${exp.length?`üö® Expired: ${exp.map(p=>p.name).join(', ')}`:''}`, timer:7000, toast:true, position:'top-end' });
  }
}

/* ================== PRODUCTS ================== */
document.getElementById('productForm').addEventListener('submit', e=>{
  e.preventDefault();
  const id = document.getElementById('editProductId').value;
  const name = document.getElementById('pName').value.trim();
  const price = parseFloat(document.getElementById('pPrice').value) || 0;
  const cost = parseFloat(document.getElementById('pCost').value) || 0;
  const qty = parseInt(document.getElementById('pQty').value) || 0;
  const low = parseInt(document.getElementById('pLow').value) || 5;
  const expiry = document.getElementById('pExpiry').value;
  if(!name || !expiry || price <= 0 || cost <= 0 || qty < 0){ Swal.fire('Error','Invalid input','error'); return; }
  let products = load(K_PROD);
  if(!id && products.some(p => p.name.toLowerCase() === name.toLowerCase())){ Swal.fire('Duplicate','Product exists','warning'); return; }
  if(id){ const i = products.findIndex(p=>p.id===id); if(i!==-1) products[i] = {...products[i], name, price, cost, qty, low, expiry}; }
  else { products.push({ id: uid('p'), name, price, cost, qty, low, expiry }); }
  if(save(K_PROD, products)){ document.getElementById('productForm').reset(); document.getElementById('editProductId').value = ''; renderProducts(); updateDashboard(); showToast('success', id ? 'Product updated' : 'Product added'); }
});

document.getElementById('filterProd').addEventListener('input', renderProducts);
function renderProducts(){
  const q = document.getElementById('filterProd').value.toLowerCase(), products = load(K_PROD), tbody = document.getElementById('productsTable');
  tbody.innerHTML = products.filter(p => !q || p.name.toLowerCase().includes(q)).map(p => {
    const expClass = isExpiredLocal(p.expiry) ? 'expiry-danger' : '', lowBadge = p.qty <= p.low ? '<span class="low-badge ms-2">Low</span>' : '';
    return `<tr><td>${escapeHtml(p.name)}</td><td>${fmt(p.price)}</td><td>${fmt(p.cost)}</td><td>${p.qty}${lowBadge}</td><td>${p.low}</td><td class="${expClass}">${p.expiry}</td><td><button class="btn btn-sm btn-outline-primary me-1" data-edit="${p.id}"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" data-del="${p.id}"><i class="bi bi-trash"></i></button></td></tr>`;
  }).join('') || '<tr><td colspan="7" class="text-center text-muted">No products</td></tr>';
}

document.getElementById('productsTable').addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const id = btn.dataset.edit || btn.dataset.del;
  let products = load(K_PROD);
  if(btn.dataset.edit){ const p = products.find(x=>x.id===id); if(p){ document.getElementById('editProductId').value = p.id; document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pCost').value = p.cost; document.getElementById('pQty').value = p.qty; document.getElementById('pLow').value = p.low; document.getElementById('pExpiry').value = p.expiry; } }
  else if(btn.dataset.del){ Swal.fire({ title:'Delete?', icon:'warning', showCancelButton:true }).then(r => { if(r.isConfirmed){ products = products.filter(x=>x.id!==id); save(K_PROD, products); renderProducts(); updateDashboard(); showToast('success','Deleted'); } }); }
});

/* ================== SELL / CART ================== */
function renderSell(){ cart = []; document.getElementById('searchProduct').value = ''; document.getElementById('payType').value = 'Paid'; document.getElementById('custName').value = ''; document.getElementById('custPhone').value = ''; document.getElementById('custName').style.display = 'none'; document.getElementById('custPhone').style.display = 'none'; renderProductList(); renderCart(); }

document.getElementById('searchProduct').addEventListener('input', renderProductList);

function renderProductList(){
  const q = document.getElementById('searchProduct').value.toLowerCase(), products = load(K_PROD).filter(p => !isExpiredLocal(p.expiry)), container = document.getElementById('productList');
  container.innerHTML = products.filter(p => !q || p.name.toLowerCase().includes(q)).map(p=>`
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
      <div><strong>${escapeHtml(p.name)}</strong><br><small class="text-muted">Price: ${fmt(p.price)} ¬∑ Stock: ${p.qty}</small></div>
      <div class="d-flex gap-2"><input type="number" class="form-control form-control-sm qtyInp" value="1" min="1" max="${p.qty}" style="width:80px"><button class="btn-accent btn-sm addBtn" data-id="${p.id}">Add</button></div>
    </div>
  `).join('') || '<div class="empty-state">No products available</div>';
}

document.getElementById('productList').addEventListener('click', e=>{
  const btn = e.target.closest('button.addBtn'); if(!btn) return;
  const id = btn.dataset.id, qtyInput = btn.parentElement.querySelector('.qtyInp'), qty = Math.max(1, parseInt(qtyInput.value)||1);
  const products = load(K_PROD), product = products.find(p => p.id === id);
  if(!product){ Swal.fire('Error','Product not found','error'); return; }
  if(qty > product.qty){ Swal.fire('Stock Error', `Only ${product.qty} units available`,'error'); return; }
  const existing = cart.find(item => item.id === id);
  if(existing){ const newQty = existing.qty + qty; if(newQty > product.qty){ Swal.fire('Stock Error',`Cannot add more than ${product.qty} units`,'error'); return; } existing.qty = newQty; }
  else { cart.push({ id: product.id, name: product.name, price: product.price, cost: product.cost, qty }); }
  renderCart(); qtyInput.value = 1;
});

function renderCart(){
  const container = document.getElementById('cartArea');
  container.innerHTML = cart.length ? `<table class="table table-sm"><thead class="table-light"><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th width="50"></th></tr></thead><tbody>${cart.map((item,i)=>`<tr><td>${escapeHtml(item.name)}</td><td><input type="number" class="form-control form-control-sm cartQty" data-idx="${i}" value="${item.qty}" min="1" style="width:70px"></td><td>${fmt(item.price)}</td><td>${fmt(item.qty*item.price)}</td><td><button class="btn btn-sm btn-outline-danger rmBtn" data-idx="${i}"><i class="bi bi-x"></i></button></td></tr>`).join('')}</tbody></table><div class="text-end mt-3"><h5>Total: ${fmt(cart.reduce((sum,item)=>sum + item.qty * item.price, 0))}</h5></div>` : '<div class="empty-state">Cart is empty</div>';
}

document.getElementById('cartArea').addEventListener('click', e=>{ const btn = e.target.closest('button.rmBtn'); if(btn){ cart.splice(btn.dataset.idx,1); renderCart(); } });
document.getElementById('cartArea').addEventListener('change', e=>{ const input = e.target.closest('input.cartQty'); if(!input) return; const i = parseInt(input.dataset.idx); const newQty = Math.max(1, parseInt(input.value)||1); const product = load(K_PROD).find(p => p.id === cart[i].id); if(!product) return; if(newQty > product.qty){ Swal.fire('Stock Error', `Only ${product.qty} units available`,'error'); input.value = cart[i].qty; return; } cart[i].qty = newQty; renderCart(); });

document.getElementById('payType').addEventListener('change', e=>{ const isCredit = e.target.value === 'Credit'; document.getElementById('custName').style.display = isCredit ? 'block' : 'none'; document.getElementById('custPhone').style.display = isCredit ? 'block' : 'none'; });

/* ================== SAVE SALE ================== */
document.getElementById('btnSaveSale').addEventListener('click', ()=>{
  if(!cart.length){ Swal.fire('Empty Cart','Add items first','warning'); return; }
  const payment = document.getElementById('payType').value, name = document.getElementById('custName').value.trim(), phone = document.getElementById('custPhone').value.trim();
  if(payment === 'Credit' && (!name || !phone)){ Swal.fire('Missing Info','Customer details required for credit','warning'); return; }
  const products = load(K_PROD), errors = [];
  cart.forEach(item => { const p = products.find(x => x.id === item.id); if(!p) errors.push(`${item.name}: not found`); else if(item.qty > p.qty) errors.push(`${item.name}: only ${p.qty} available`); });
  if(errors.length){ Swal.fire('Stock Issues', errors.join('<br>'), 'error'); return; }
  cart.forEach(item => products.find(x => x.id === item.id).qty -= item.qty);
  const total = cart.reduce((sum,item)=>sum + item.qty * item.price, 0);
  const sale = { id: uid('INV'), date: new Date().toISOString(), total, payment, lines: JSON.parse(JSON.stringify(cart)), user: currentUser.username, returned: false, customer: payment === 'Credit' ? { name, phone } : null };
  const sales = load(K_SALES); sales.push(sale);
  if(payment === 'Credit'){ let patients = load(K_PATIENTS); let patient = patients.find(p=>p.phone === phone); if(patient){ patient.balance = (patient.balance||0) + total; patient.name = name; } else { patients.push({ id: uid('c'), name, phone, balance: total }); } save(K_PATIENTS, patients); }
  if(save(K_PROD, products) && save(K_SALES, sales)){
    const dt = new Date(sale.date).toLocaleString();
    let rc = `<div style="text-align:center;border-bottom:1px dashed;margin-bottom:10px;padding-bottom:10px;"><strong>‚òÖ BAXNAANO PHARMACY ‚òÖ</strong><br><small>${dt}</small><br><b>Receipt #${sale.id}</b><br>Served by: ${escapeHtml(currentUser.username)}</div>`;
    sale.lines.forEach(l => rc += `<div style="display:flex;justify-content:space-between;margin-bottom:5px;">${escapeHtml(l.name)} x${l.qty}<span>${fmt(l.qty*l.price)}</span></div>`);
    rc += `<div style="border-top:1px dashed;margin-top:10px;padding-top:10px;"><div style="display:flex;justify-content:space-between;"><b>TOTAL:</b><b>${fmt(total)}</b></div><div style="display:flex;justify-content:space-between;"><b>Type:</b><b>${payment}</b></div>${sale.customer?`<div style="display:flex;justify-content:space-between;"><b>Customer:</b><b>${escapeHtml(name)}</b></div>`:''}</div><div style="text-align:center;margin-top:15px;border-top:1px dashed;padding-top:10px;"><small>Thank you for your purchase!</small></div>`;
    const pw = window.open('','_blank'); pw.document.write(`<html><head><title>Receipt</title><style>body{font-family:monospace;margin:0;padding:16px}.receipt{max-width:320px;margin:0 auto}</style></head><body><div class="receipt">${rc}</div><script>window.print();setTimeout(()=>window.close(),100);</script></body></html>`); pw.document.close();
    cart = []; renderCart(); renderProductList(); updateDashboard(); showAlerts(); showToast('success','Sale completed');
  }
});

/* ================== REPORTS ================== */
document.getElementById('reportRange').addEventListener('change', e=>{ const isCustom = e.target.value === 'custom'; document.getElementById('rFrom').style.display = isCustom ? 'inline-block' : 'none'; document.getElementById('rTo').style.display = isCustom ? 'inline-block' : 'none'; renderReports(); });
document.getElementById('rFrom').addEventListener('change', renderReports);
document.getElementById('rTo').addEventListener('change', renderReports);

function renderReports(){
  const range = document.getElementById('reportRange').value; let from = null, to = null;
  if(range === 'today'){ from = startOfLocalDay(new Date()); to = endOfLocalDay(new Date()); }
  else if(range === 'week'){ from = new Date(); from.setDate(from.getDate() - 7); to = new Date(); }
  else if(range === 'month'){ from = new Date(); from.setDate(1); to = new Date(); }
  else if(range === 'custom'){ const f = document.getElementById('rFrom').value, t = document.getElementById('rTo').value; if(f) from = startOfLocalDay(new Date(f + 'T00:00:00')); if(t) to = endOfLocalDay(new Date(t + 'T23:59:59')); }
  const sales = load(K_SALES).filter(s => { if(s.returned) return false; const d = new Date(s.date); if(from && d < from) return false; if(to && d > to) return false; if(currentUser.role === 'cashier' && s.user !== currentUser.username) return false; return true; });
  document.getElementById('repTotal').textContent = fmt(sales.reduce((sum,s)=>sum + Number(s.total), 0));
  const items = {}; sales.forEach(s => s.lines.forEach(l => items[l.name] = (items[l.name]||0) + l.qty));
  document.getElementById('repItems').innerHTML = Object.keys(items).length ? `<ul class="list-group">${Object.entries(items).sort((a,b)=>b[1]-a[1]).map(([n,q])=>`<li class="list-group-item d-flex justify-content-between">${escapeHtml(n)}<span class="badge bg-primary rounded-pill">${q}</span></li>`).join('')}</ul>` : '<div class="empty-state">No items sold</div>';
  const recent = load(K_SALES).slice().reverse().filter(s => currentUser.role !== 'cashier' || s.user === currentUser.username).slice(0,50);
  document.getElementById('recentSalesTbl').innerHTML = recent.map(s => `<tr class="${s.returned?'table-warning':''}"><td>${s.id}</td><td>${new Date(s.date).toLocaleString()}</td><td>${fmt(s.total)}</td><td>${s.payment}</td><td>${escapeHtml(s.user)}</td></tr>`).join('') || '<tr><td colspan="5" class="text-center text-muted">No sales</td></tr>';
  const patients = load(K_PATIENTS).filter(p => p.balance > 0);
  document.getElementById('creditList').innerHTML = patients.length ? `<ul class="list-group">${patients.map(p=>`<li class="list-group-item d-flex justify-content-between"><div><strong>${escapeHtml(p.name)}</strong><br><small class="text-muted">${escapeHtml(p.phone)}</small></div><span class="badge bg-warning rounded-pill">${fmt(p.balance)}</span></li>`).join('')}</ul>` : '<div class="empty-state">No credit accounts</div>';
}

/* ================== CREDIT PAYMENTS ================== */
function renderCreditView(){ renderCreditAccounts(); document.getElementById('creditPaymentForm').reset(); document.getElementById('paymentResult').innerHTML=''; }
function renderCreditAccounts(){ const patients = load(K_PATIENTS), container = document.getElementById('creditAccountsList'); container.innerHTML = patients.length ? `<ul class="list-group">${patients.map(p=>`<li class="list-group-item d-flex justify-content-between"><div><strong>${escapeHtml(p.name)}</strong><br><small class="text-muted">${escapeHtml(p.phone)}</small><br><small class="text-muted">ID: ${p.id}</small></div><h5 class="${p.balance>0?'text-warning':'text-success'}">${fmt(p.balance||0)}</h5></li>`).join('')}</ul>` : '<div class="empty-state">No credit customers</div>'; }

document.getElementById('creditPaymentForm').addEventListener('submit', e=>{
  e.preventDefault();
  const search = document.getElementById('searchCustomer').value.trim(), amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
  if(!search || amount <= 0){ Swal.fire('Invalid Input','Enter customer and valid amount','warning'); return; }
  let patients = load(K_PATIENTS);
  const patient = patients.find(p => p.phone.includes(search) || p.name.toLowerCase().includes(search.toLowerCase()));
  if(!patient){ Swal.fire('Not Found','Customer not found','error'); return; }
  if(amount > patient.balance){ Swal.fire('Invalid Amount',`Customer owes ${fmt(patient.balance)}`,'error'); return; }
  patient.balance = Math.max(0, patient.balance - amount);
  const payments = load(K_PAYMENTS);
  payments.push({ id: uid('PAY'), customerId: patient.id, patientName: patient.name, amount, note: document.getElementById('paymentNote').value.trim(), date: new Date().toISOString(), user: currentUser.username });
  if(save(K_PATIENTS, patients) && save(K_PAYMENTS, payments)){ showToast('success', `Payment recorded: ${fmt(amount)}`); renderCreditAccounts(); renderReports(); }
});

/* ================== RETURNS ================== */
function processReturn(orderId){
  if(!orderId){ Swal.fire('Error','Enter Order ID','warning'); return; }
  if(currentUser.role !== 'admin'){ Swal.fire('Access Denied','Admin only','error'); return; }
  const sales = load(K_SALES), index = sales.findIndex(s => s.id === orderId);
  if(index === -1){ Swal.fire('Not Found','Order not found','error'); return; }
  const sale = sales[index];
  if(sale.returned){ Swal.fire('Already Returned','This order was returned','info'); return; }
  if((Date.now() - new Date(sale.date).getTime())/36e5 > 24){ Swal.fire('Return Expired','Only within 24 hours','error'); return; }
  Swal.fire({ title:'Process Return?', text:`Return ${sale.lines.length} item(s) from ${orderId}?`, icon:'question', showCancelButton:true }).then(r=>{
    if(r.isConfirmed){
      let products = load(K_PROD);
      sale.lines.forEach(l => { const p = products.find(x => x.id === l.id); if(p) p.qty += l.qty; });
      sales[index].returned = true;
      const returns = load(K_RETURNS);
      returns.push({ id: uid('r'), orderId: sale.id, date: new Date().toISOString(), user: currentUser.username });
      if(save(K_PROD, products) && save(K_SALES, sales) && save(K_RETURNS, returns)){ showToast('success','Return processed'); updateDashboard(); renderReports(); renderReturnsHistory(); document.getElementById('returnOrderId').value = ''; document.getElementById('returnResult').innerHTML = '<div class="alert alert-success">‚úì Return processed</div>'; }
    }
  });
}
function renderReturnsHistory(){ const returns = load(K_RETURNS), container = document.getElementById('returnsList'); container.innerHTML = returns.length ? `<ul class="list-group">${returns.slice().reverse().map(r => `<li class="list-group-item"><div class="d-flex justify-content-between"><div><strong>${r.orderId}</strong><br><small class="text-muted">${new Date(r.date).toLocaleString()}</small></div><span class="badge bg-success">‚úì Returned</span></div></li>`).join('')}</ul>` : '<div class="empty-state">No returns yet</div>'; }

/* ================== USERS ================== */
document.getElementById('userForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const username = document.getElementById('uName').value.trim(), password = document.getElementById('uPass').value, role = document.getElementById('uRole').value;
  if(!username || password.length < 4){ Swal.fire('Invalid','Username required and password min 4 chars','warning'); return; }
  let users = load(K_USERS); if(users.find(u=>u.username === username)){ Swal.fire('Exists','Username taken','warning'); return; }
  const hash = await sha256hex(password);
  users.push({ username, passwordHash: hash, role, created: new Date().toISOString() });
  if(save(K_USERS, users)){ showToast('success','User added'); document.getElementById('userForm').reset(); renderUsers(); }
});
function renderUsers(){ const tbody = document.getElementById('usersTable'), users = load(K_USERS); tbody.innerHTML = users.map(u => `<tr><td>${escapeHtml(u.username)}</td><td><span class="badge ${u.role==='admin'?'bg-danger':'bg-primary'}">${u.role}</span></td><td>${u.role!=='admin' ? `<button class="btn btn-sm btn-outline-danger" data-del="${u.username}"><i class="bi bi-trash"></i></button>` : ''}</td></tr>`).join('') || '<tr><td colspan="3" class="text-center text-muted">No users</td></tr>'; }
document.getElementById('usersTable').addEventListener('click', e=>{ const btn = e.target.closest('button[data-del]'); if(btn){ Swal.fire({ title:'Delete User?', icon:'warning', showCancelButton:true }).then(r=>{ if(r.isConfirmed){ let users = load(K_USERS); save(K_USERS, users.filter(u => u.username !== btn.dataset.del)); renderUsers(); showToast('success','User deleted'); } }); } });

/* ================== INITIALIZATION ================== */
function initUI(){
  document.querySelector('.navlink[data-target="dashboard"]').click();
  document.getElementById('rFrom').value = getTodayString(); document.getElementById('rTo').value = getTodayString();
  // ensure admin-only visibility correct
  if(currentUser && currentUser.role === 'admin'){ document.body.classList.add('is-admin'); } else { document.body.classList.remove('is-admin'); }
}

/* If user had session set when page loaded we do nothing more (handled in load) */
</script>
</body>
</html>
