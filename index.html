<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy POS - Nidaamka Dawacadda</title>
    
    <!-- CDN imports -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-attachment: fixed; min-height: 100vh; color: #333; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 2.5rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-box h2 { margin-bottom: 1.5rem; text-align: center; color: #667eea; }
        .login-input { width: 100%; padding: 12px 15px; margin-bottom: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: all 0.3s; }
        .login-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .login-btn:hover { transform: translateY(-2px); }
        .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 1rem 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; display: none; }
        .nav-brand { font-size: 1.4rem; font-weight: bold; color: #667eea; }
        .nav-menu { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .nav-btn { padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .nav-btn:hover { background: #667eea; color: white; }
        .nav-btn.active { background: #667eea; color: white; }
        .nav-right { margin-left: auto; display: flex; gap: 1rem; align-items: center; }
        .user-info { font-weight: 500; color: #667eea; }
        .unified-section { min-height: 100vh; padding: 2rem 1.5rem; display: none; }
        .unified-section.active { display: block; }
        .stat { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .stat:hover { transform: translateY(-5px); }
        .stat small { font-size: 0.85rem; color: #6c757d; }
        .stat div { font-size: 1.8rem; font-weight: bold; color: #667eea; margin-top: 0.5rem; }
        .card-modern { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .table { width: 100%; }
        .table th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; }
        .table td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; }
        .btn-accent { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-accent:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-danger { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1.5rem; }
        .d-flex { display: flex; }
        .d-none { display: none !important; }
        .d-block { display: block !important; }
        .w-100 { width: 100%; }
        .w-auto { width: auto; }
        .ms-auto { margin-left: auto; }
        .flex-wrap { flex-wrap: wrap; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        .text-success { color: #28a745; }
        .text-warning { color: #ffc107; }
        .table-warning { background-color: #fff3cd; }
        .alert { padding: 12px; border-radius: 6px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .list-group { list-style: none; padding: 0; }
        .list-group-item { padding: 12px; border: 1px solid #e0e0e0; border-bottom: none; background: white; }
        .list-group-item:last-child { border-bottom: 1px solid #e0e0e0; border-radius: 0 0 6px 6px; }
        .list-group-item:first-child { border-radius: 6px 6px 0 0; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .bg-primary { background: #667eea; color: white; }
        .rounded-pill { border-radius: 50rem; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        
        /* Chart container fix */
        #chartSales { max-width: 100%; height: auto !important; }
        
        @media (max-width: 768px) {
            .unified-section { padding: 1rem 0.75rem; }
            .nav-menu { flex-direction: column; width: 100%; margin-top: 1rem; }
            .nav-btn { width: 100%; }
            .nav-right { margin-left: 0; margin-top: 1rem; width: 100%; }
            .login-box { padding: 1.5rem; }
        }
    </style>
</head>
<body>

<!-- Login View -->
<div id="loginContainer" class="login-container">
    <div class="login-box">
        <h2>üîê Login</h2>
        <input type="text" id="loginUsername" class="login-input" placeholder="Username" maxlength="50" autocomplete="username">
        <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password">
        <button id="loginBtn" class="login-btn">Login</button>
    </div>
</div>

<!-- Navigation -->
<div id="navbar" class="navbar">
    <div class="nav-brand">üíä Pharmacy POS</div>
    <div class="nav-menu" id="navMenu">
        <!-- Nav buttons will be dynamically generated based on role -->
    </div>
    <div class="nav-right">
        <span class="user-info" id="userDisplay"></span>
        <button class="btn-accent" id="logoutBtn">Logout</button>
    </div>
</div>

<!-- Dashboard View (Admin Only) -->
<div id="dashboardView" class="unified-section">
    <h6 class="mb-3"><i class="bi bi-speedometer2"></i> Dashboard Overview</h6>
    <div class="row g-3 mb-4" style="display: flex; gap: 1rem;">
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">Today Sales</small><div id="statToday">$0.00</div></div></div>
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">This Week</small><div id="statWeek">$0.00</div></div></div>
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">This Month</small><div id="statMonth">$0.00</div></div></div>
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">Total Medicines</small><div id="statMedicines">0</div></div></div>
    </div>
    <div class="row g-3 mb-4" style="display: flex; gap: 1rem;">
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">Total Profit</small><div id="statProfit">$0.00</div></div></div>
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">Total Products</small><div id="statProducts">0</div></div></div>
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">Low Stock Items</small><div id="statLowStock">0</div></div></div>
        <div class="col-md-3" style="flex: 1;"><div class="stat"><small class="text-muted">Credit Amount</small><div id="statCredit">$0.00</div></div></div>
    </div>
    <div class="row g-3" style="display: flex; gap: 1rem;">
        <div class="col-md-8" style="flex: 2;"><div class="card-modern"><h6>üìà Sales Chart (Last 14 Days)</h6><canvas id="chartSales" height="120"></canvas></div></div>
        <div class="col-md-4" style="flex: 1;"><div class="card-modern"><h6>üèÜ Top Sold Items</h6><div id="topSoldList"></div></div></div>
    </div>
    <div class="card-modern mt-3"><h6>‚ö†Ô∏è Stock & Expiry Alerts</h6><div id="lowStockAlerts"></div></div>
</div>

<!-- POS View (Cashier & Admin) -->
<div id="sellView" class="unified-section">
    <h6 class="mb-3"><i class="bi bi-receipt"></i> Point of Sale</h6>
    <div class="row g-3" style="display: flex; gap: 1rem;">
        <div class="col-md-6" style="flex: 1;">
            <input id="searchProduct" class="form-control mb-3" placeholder="üîç Search product by name...">
            <div id="productList" style="max-height:420px;overflow:auto"></div>
        </div>
        <div class="col-md-6" style="flex: 1;">
            <h6>üõí Shopping Cart</h6>
            <div id="cartArea"></div>
            <div class="d-flex gap-2 mt-3 flex-wrap" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <select id="payType" class="form-select w-auto">
                    <option value="Paid">üíµ Paid</option>
                    <option value="Credit">üí≥ Credit</option>
                </select>
                <input id="custName" class="form-control" placeholder="Customer Name (Credit)" style="display:none" autocomplete="off">
                <input id="custPhone" class="form-control" placeholder="Phone (Credit)" style="display:none" autocomplete="off">
                <button class="btn-accent ms-auto" id="btnSaveSale">üñ®Ô∏è Save & Print Receipt</button>
            </div>
        </div>
    </div>
</div>

<!-- Products View (Admin Only) -->
<div id="productsView" class="unified-section admin-only">
    <h6 class="mb-3"><i class="bi bi-pills"></i> Manage Products</h6>
    <form id="productForm" class="row g-2 mb-3">
        <input type="hidden" id="editProductId">
        <div class="col-md-3"><input id="pName" class="form-control" placeholder="Medicine Name" required maxlength="100"></div>
        <div class="col-md-2"><input id="pPrice" class="form-control" type="number" min="0.01" step="0.01" placeholder="Sale Price $" required></div>
        <div class="col-md-2"><input id="pCost" class="form-control" type="number" min="0.01" step="0.01" placeholder="Cost Price $" required></div>
        <div class="col-md-1"><input id="pQty" class="form-control" type="number" min="0" placeholder="Qty" required></div>
        <div class="col-md-1"><input id="pLow" class="form-control" type="number" min="0" placeholder="Low Alert" value="5" required></div>
        <div class="col-md-2"><input id="pExpiry" class="form-control" type="date" required></div>
        <div class="col-md-1"><button class="btn-accent w-100" type="submit">Save</button></div>
    </form>
    <input id="filterProd" class="form-control mb-3" placeholder="üîç Filter products...">
    <div style="max-height:360px;overflow:auto">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Qty</th>
                    <th>Low</th>
                    <th>Expiry</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="productsTable"></tbody>
        </table>
    </div>
</div>

<!-- Reports View (Cashier & Admin) -->
<div id="reportsView" class="unified-section">
    <h6 class="mb-3"><i class="bi bi-graph-up"></i> Sales Reports</h6>
    <div class="row g-3" style="display: flex; gap: 1rem;">
        <div class="col-md-6" style="flex: 1;">
            <div class="d-flex gap-2 align-items-center mb-3 flex-wrap">
                <label>üìÖ Range:</label>
                <select id="reportRange" class="form-select w-auto">
                    <option value="today">Today</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                    <option value="all">All</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="date" id="rFrom" style="display:none">
                <input type="date" id="rTo" style="display:none">
            </div>
            <h4 id="repTotal">$0.00</h4>
            <div class="text-muted mb-3">Total sales in selected range</div>
            <h6>üì¶ Items Sold Breakdown</h6>
            <div id="repItems" style="max-height:260px;overflow:auto"></div>
        </div>
        <div class="col-md-6" style="flex: 1;">
            <h6>üõí Recent Sales</h6>
            <div style="max-height:360px;overflow:auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Type</th>
                            <th>User</th>
                        </tr>
                    </thead>
                    <tbody id="recentSalesTbl"></tbody>
                </table>
            </div>
            <div class="admin-only">
                <hr>
                <h6>üí≥ Credit Accounts</h6>
                <div id="creditList" style="max-height:200px;overflow:auto"></div>
            </div>
        </div>
    </div>
</div>

<!-- Returns View (Admin Only) -->
<div id="returnsView" class="unified-section admin-only">
    <h6 class="mb-3"><i class="bi bi-arrow-return-left"></i> Process Returns (Admin)</h6>
    <div class="card-modern">
        <div class="d-flex gap-2 mb-3">
            <input id="returnOrderId" class="form-control" placeholder="Enter Order ID (e.g., INV_...)">
            <button class="btn-accent" id="processReturnBtn">Process Return</button>
        </div>
        <div id="returnResult"></div>
        <h6 class="mt-4">üìú Returns History</h6>
        <div id="returnsList" style="max-height:300px;overflow:auto"></div>
    </div>
</div>

<!-- Users View (Admin Only) -->
<div id="usersView" class="unified-section admin-only">
    <h6 class="mb-3"><i class="bi bi-people"></i> Manage Users</h6>
    <form id="userForm" class="row g-2 mb-3">
        <div class="col-md-4"><input id="uName" class="form-control" placeholder="Username" required maxlength="50"></div>
        <div class="col-md-4"><input id="uPass" class="form-control" placeholder="Password" required minlength="4"></div>
        <div class="col-md-4">
            <select id="uRole" class="form-select">
                <option value="cashier">Cashier</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <div class="col-12"><button class="btn-accent" type="submit">‚ûï Add User</button></div>
    </form>
    <div style="max-height:360px;overflow:auto">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="usersTable"></tbody>
        </table>
    </div>
</div>

<!-- Credit View (Admin Only - Hidden for Cashier) -->
<div id="creditView" class="unified-section admin-only">
    <h6 class="mb-3"><i class="bi bi-credit-card"></i> Credit Payments</h6>
    <div class="row g-3" style="display: flex; gap: 1rem;">
        <div class="col-md-6" style="flex: 1;">
            <div class="card-modern">
                <h6>üí∞ Record Payment</h6>
                <form id="creditPaymentForm">
                    <div class="mb-3"><input id="searchCustomer" class="form-control" placeholder="üîç Search customer by name or phone..." required></div>
                    <div class="mb-3"><input id="paymentAmount" class="form-control" type="number" min="0.01" step="0.01" placeholder="Payment Amount $" required></div>
                    <div class="mb-3"><input id="paymentNote" class="form-control" placeholder="Note (optional)"></div>
                    <button class="btn-accent w-100" type="submit">üí≥ Record Payment</button>
                </form>
            </div>
            <div id="paymentResult" class="mt-3"></div>
        </div>
        <div class="col-md-6" style="flex: 1;">
            <h6>üë• Customer Credit Accounts</h6>
            <div id="creditAccountsList" style="max-height:400px;overflow:auto"></div>
        </div>
    </div>
</div>

<script>
// ==================== CONSTANTS & STORAGE KEYS ====================
const K_USERS = 'pharma_users';
const K_SALES = 'pharma_sales';
const K_PROD = 'pharma_products';
const K_PATIENTS = 'pharma_patients';
const K_RETURNS = 'pharma_returns';
const K_PAYMENTS = 'pharma_payments';
const K_AUDIT = 'pharma_audit';

// ==================== UTILITY FUNCTIONS ====================
function load(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
    } catch (e) {
        console.error(`Error loading ${key}:`, e);
        return [];
    }
}

function save(key, data) {
    try {
        const optimizedData = optimizeData(key, data);
        const compressed = JSON.stringify(optimizedData);
        
        if (key === K_SALES && data.length > 1000) {
            keepLast(1000);
        }
        
        localStorage.setItem(key, compressed);
        return true;
    } catch (e) {
        console.error(`Storage error for ${key}:`, e);
        
        let message = 'Unknown error';
        if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
            message = 'Storage is full! Cleaning old data...';
            autoCleanup();
        } else if (e.name === 'SecurityError') {
            message = 'Browser blocked storage. Disable private mode.';
        } else if (e.name === 'TypeError') {
            message = 'Invalid data format. Check for errors.';
        } else {
            message = e.message;
        }
        
        Swal.fire({icon: 'error', title: 'Storage Error', text: message});
        return false;
    }
}

function optimizeData(key, data) {
    if (!Array.isArray(data)) return data;
    return data.map(item => {
        const optimized = {...item};
        Object.keys(optimized).forEach(k => {
            if (optimized[k] === undefined || (typeof optimized[k] === 'number' && isNaN(optimized[k]))) {
                delete optimized[k];
            }
        });
        return optimized;
    });
}

function keepLast(maxItems) {
    const keys = [K_SALES, K_AUDIT];
    keys.forEach(key => {
        const items = load(key);
        if (items.length > maxItems) {
            localStorage.setItem(key, JSON.stringify(items.slice(-maxItems)));
        }
    });
}

function autoCleanup() {
    try {
        const audit = load(K_AUDIT);
        if (audit.length > 500) save(K_AUDIT, audit.slice(-500));
        
        const sales = load(K_SALES);
        const twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        const filteredSales = sales.filter(s => new Date(s.date) > twoYearsAgo);
        if (sales.length !== filteredSales.length) save(K_SALES, filteredSales);
        
        const returns = load(K_RETURNS);
        if (returns.length > 1000) save(K_RETURNS, returns.slice(-1000));
        
        Swal.fire({icon: 'success', title: 'Cleanup completed', timer: 2000});
    } catch (e) {
        Swal.fire({icon: 'error', title: 'Cleanup failed'});
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function fmt(amount) {
    return '$' + (parseFloat(amount) || 0).toFixed(2);
}

function uid(prefix) {
    return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

function nowISO() {
    return new Date().toISOString();
}

async function hashPassword(password) {
    try {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
    } catch {
        return btoa(password.split('').reverse().join(''));
    }
}

// ==================== GLOBAL STATE ====================
let currentUser = null;
let cart = [];
let salesChart = null;

// ==================== INITIAL DATA ====================
async function initDefaultData() {
    const users = load(K_USERS);
    if (users.length === 0) {
        const hash = await hashPassword('admin123');
        save(K_USERS, [{username: 'admin', password: hash, role: 'admin'}]);
    }
    
    const products = load(K_PROD);
    if (products.length === 0) {
        save(K_PROD, [
            {id: uid('PROD'), name: 'Amoxicillin 500mg', price: 15.99, cost: 8.50, qty: 100, low: 10, expiry: '2025-12-31', created: nowISO()},
            {id: uid('PROD'), name: 'Paracetamol 500mg', price: 5.99, cost: 2.50, qty: 200, low: 20, expiry: '2026-06-30', created: nowISO()}
        ]);
    }
}

// ==================== SESSION MANAGEMENT ====================
async function checkSession() {
    const session = localStorage.getItem('pharma_session');
    if (session) {
        const users = load(K_USERS);
        currentUser = users.find(u => u.username === session);
        if (currentUser) {
            showMainApp();
            return;
        }
    }
    showLogin();
}

function showLogin() {
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('navbar').style.display = 'none';
    document.querySelectorAll('.unified-section').forEach(el => el.classList.remove('active'));
}

function showMainApp() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('navbar').style.display = 'flex';
    document.getElementById('userDisplay').textContent = `üë§ ${currentUser.username} (${currentUser.role})`;
    
    // Generate nav menu based on role
    generateNavMenu();
    
    // Hide all admin-only sections
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
    });
    
    // For cashier, redirect to sell view and hide dashboard
    if (currentUser.role === 'cashier') {
        document.getElementById('dashboardView').style.display = 'none';
        showView('sell');
        // Set active nav button
        setTimeout(() => {
            const sellBtn = document.querySelector('[data-view="sell"]');
            if (sellBtn) sellBtn.classList.add('active');
        }, 100);
    } else {
        // Admin starts at dashboard
        showView('dashboard');
        setTimeout(() => {
            const dashboardBtn = document.querySelector('[data-view="dashboard"]');
            if (dashboardBtn) dashboardBtn.classList.add('active');
        }, 100);
    }
}

// ==================== NAVIGATION ====================
function generateNavMenu() {
    const navMenu = document.getElementById('navMenu');
    navMenu.innerHTML = '';
    
    const navButtons = [];
    
    if (currentUser.role === 'admin') {
        navButtons.push(
            { view: 'dashboard', text: 'Dashboard', icon: 'bi bi-speedometer2' },
            { view: 'sell', text: 'POS', icon: 'bi bi-receipt' },
            { view: 'products', text: 'Products', icon: 'bi bi-pills' },
            { view: 'reports', text: 'Reports', icon: 'bi bi-graph-up' },
            { view: 'returns', text: 'Returns', icon: 'bi bi-arrow-return-left' },
            { view: 'users', text: 'Users', icon: 'bi bi-people' },
            { view: 'credit', text: 'Credit', icon: 'bi bi-credit-card' }
        );
    } else {
        // Cashier only sees POS and Reports
        navButtons.push(
            { view: 'sell', text: 'POS', icon: 'bi bi-receipt' },
            { view: 'reports', text: 'Reports', icon: 'bi bi-graph-up' }
        );
    }
    
    navButtons.forEach(btn => {
        const button = document.createElement('button');
        button.className = 'nav-btn';
        button.dataset.view = btn.view;
        button.innerHTML = `<i class="${btn.icon}"></i> ${btn.text}`;
        button.addEventListener('click', () => {
            showView(btn.view);
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
        });
        navMenu.appendChild(button);
    });
}

function showView(viewName) {
    document.querySelectorAll('.unified-section').forEach(el => el.classList.remove('active'));
    document.getElementById(viewName + 'View').classList.add('active');
    
    if (viewName === 'dashboard') renderDashboard();
    if (viewName === 'sell') renderPOS();
    if (viewName === 'products') renderProducts();
    if (viewName === 'reports') renderReports();
    if (viewName === 'returns') renderReturnsHistory();
    if (viewName === 'users') renderUsers();
    if (viewName === 'credit') renderCreditView();
}

// ==================== DASHBOARD (Admin Only) ====================
function renderDashboard() {
    if (currentUser.role !== 'admin') return;
    
    const sales = load(K_SALES).filter(s => !s.returned);
    const today = new Date();
    today.setHours(0,0,0,0);
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const todaySales = sales.filter(s => new Date(s.date) >= today).reduce((a, b) => a + b.total, 0);
    const weekSales = sales.filter(s => new Date(s.date) >= weekAgo).reduce((a, b) => a + b.total, 0);
    const monthSales = sales.filter(s => new Date(s.date) >= monthStart).reduce((a, b) => a + b.total, 0);
    
    const products = load(K_PROD);
    const profit = sales.reduce((total, sale) => {
        const saleProfit = sale.lines.reduce((lineProfit, line) => {
            const prod = products.find(p => p.id === line.id);
            if (!prod) return lineProfit;
            return lineProfit + ((line.price - prod.cost) * line.qty);
        }, 0);
        return total + saleProfit;
    }, 0);
    
    const totalMedicines = products.reduce((sum, p) => sum + p.qty, 0);
    const totalProducts = products.length;
    const lowStockItems = products.filter(p => p.qty <= p.low).length;
    
    const patients = load(K_PATIENTS);
    const totalCredit = patients.reduce((sum, p) => sum + p.balance, 0);
    
    document.getElementById('statToday').textContent = fmt(todaySales);
    document.getElementById('statWeek').textContent = fmt(weekSales);
    document.getElementById('statMonth').textContent = fmt(monthSales);
    document.getElementById('statMedicines').textContent = totalMedicines.toLocaleString();
    document.getElementById('statProfit').textContent = fmt(profit);
    document.getElementById('statProducts').textContent = totalProducts.toLocaleString();
    document.getElementById('statLowStock').textContent = lowStockItems.toLocaleString();
    document.getElementById('statCredit').textContent = fmt(totalCredit);
    
    renderSalesChart();
    renderTopSold();
    renderAlerts();
}

function renderSalesChart() {
    if (currentUser.role !== 'admin') return;
    
    const canvas = document.getElementById('chartSales');
    const ctx = canvas.getContext('2d');
    
    const sales = load(K_SALES).filter(s => !s.returned);
    const last14Days = Array.from({length: 14}, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (13 - i));
        d.setHours(0,0,0,0);
        return d;
    });
    
    const data = last14Days.map(date => {
        const dayTotal = sales
            .filter(s => new Date(s.date).toDateString() === date.toDateString())
            .reduce((a, b) => a + b.total, 0);
        return dayTotal;
    });
    
    const labels = last14Days.map(d => d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
    
    if (salesChart) {
        salesChart.destroy();
    }
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Sales ($)',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Sales: ' + fmt(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    },
                    grid: { color: 'rgba(0,0,0,0.1)' }
                },
                x: {
                    grid: { display: false }
                }
            },
            interaction: { intersect: false, mode: 'index' }
        }
    });
}

function renderTopSold() {
    if (currentUser.role !== 'admin') return;
    
    const sales = load(K_SALES).filter(s => !s.returned);
    const items = {};
    sales.forEach(sale => sale.lines.forEach(l => items[l.name] = (items[l.name] || 0) + l.qty));
    
    const sorted = Object.entries(items).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const list = document.getElementById('topSoldList');
    list.innerHTML = '';
    
    if (sorted.length === 0) {
        list.innerHTML = '<p class="text-muted">No sales data yet.</p>';
        return;
    }
    
    const ul = document.createElement('ul');
    ul.className = 'list-group';
    sorted.forEach(([name, qty]) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between';
        li.innerHTML = `${escapeHtml(name)}<span class="badge bg-primary rounded-pill">${qty}</span>`;
        ul.appendChild(li);
    });
    list.appendChild(ul);
}

function renderAlerts() {
    if (currentUser.role !== 'admin') return;
    
    const products = load(K_PROD);
    const alerts = document.getElementById('lowStockAlerts');
    const today = new Date();
    today.setHours(0,0,0,0);
    const expirySoon = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
    
    const lowStock = products.filter(p => p.qty <= p.low);
    const expiring = products.filter(p => {
        const exp = new Date(p.expiry);
        return exp <= expirySoon && exp >= today;
    });
    
    alerts.innerHTML = '';
    const frag = document.createDocumentFragment();
    
    if (lowStock.length === 0 && expiring.length === 0) {
        alerts.innerHTML = '<p class="text-muted">‚úÖ No alerts.</p>';
        return;
    }
    
    lowStock.forEach(p => {
        const div = document.createElement('div');
        div.className = 'alert alert-warning';
        div.style.background = '#fff3cd';
        div.style.color = '#856404';
        div.style.border = '1px solid #ffc107';
        div.innerHTML = `<strong>Low Stock:</strong> ${escapeHtml(p.name)} (Qty: ${p.qty}, Alert: ${p.low})`;
        frag.appendChild(div);
    });
    
    expiring.forEach(p => {
        const div = document.createElement('div');
        div.className = 'alert alert-danger';
        div.style.background = '#f8d7da';
        div.style.color = '#721c24';
        div.style.border = '1px solid #dc3545';
        div.innerHTML = `<strong>Expiring Soon:</strong> ${escapeHtml(p.name)} (Expiry: ${new Date(p.expiry).toLocaleDateString()})`;
        frag.appendChild(div);
    });
    
    alerts.appendChild(frag);
}

// ==================== POS / SELL ====================
function renderPOS() {
    document.getElementById('searchProduct').value = '';
    document.getElementById('cartArea').innerHTML = '<p class="text-muted"><i class="bi bi-cart"></i> Cart is empty</p>';
    document.getElementById('payType').value = 'Paid';
    document.getElementById('custName').value = '';
    document.getElementById('custPhone').value = '';
    document.getElementById('custName').style.display = 'none';
    document.getElementById('custPhone').style.display = 'none';
    cart = [];
    renderProductList();
}

function renderProductList() {
    const products = load(K_PROD);
    const list = document.getElementById('productList');
    list.innerHTML = '';
    
    const frag = document.createDocumentFragment();
    products.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card-modern';
        div.style.cursor = 'pointer';
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${escapeHtml(p.name)}</strong><br>
                    <small class="text-muted">Price: ${fmt(p.price)} | Qty: ${p.qty}</small>
                </div>
                <button class="btn-accent" onclick="addToCart('${p.id}')">Add</button>
            </div>
        `;
        frag.appendChild(div);
    });
    
    list.appendChild(frag);
}

document.getElementById('searchProduct').addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    const products = load(K_PROD);
    const filtered = products.filter(p => p.name.toLowerCase().includes(search));
    
    const list = document.getElementById('productList');
    list.innerHTML = '';
    
    if (filtered.length === 0) {
        list.innerHTML = '<p class="text-muted">No products found.</p>';
        return;
    }
    
    const frag = document.createDocumentFragment();
    filtered.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card-modern';
        div.style.cursor = 'pointer';
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${escapeHtml(p.name)}</strong><br>
                    <small class="text-muted">Price: ${fmt(p.price)} | Qty: ${p.qty}</small>
                </div>
                <button class="btn-accent" onclick="addToCart('${p.id}')">Add</button>
            </div>
        `;
        frag.appendChild(div);
    });
    
    list.appendChild(frag);
});

function addToCart(productId) {
    const products = load(K_PROD);
    const product = products.find(p => p.id === productId);
    
    if (!product || product.qty <= 0) {
        Swal.fire({icon: 'warning', title: 'Product unavailable', text: 'Item is out of stock.'});
        return;
    }
    
    const existing = cart.find(item => item.id === productId);
    if (existing) {
        if (existing.qty < product.qty) {
            existing.qty++;
        } else {
            Swal.fire({icon: 'warning', title: 'Stock limit reached', text: `Only ${product.qty} available.`});
            return;
        }
    } else {
        cart.push({...product, qty: 1});
    }
    
    updateCartDisplay();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    updateCartDisplay();
}

function updateCartDisplay() {
    const cartArea = document.getElementById('cartArea');
    
    if (cart.length === 0) {
        cartArea.innerHTML = '<p class="text-muted"><i class="bi bi-cart"></i> Cart is empty</p>';
        return;
    }
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    cartArea.innerHTML = `
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                ${cart.map(item => `
                    <tr>
                        <td>${escapeHtml(item.name)}</td>
                        <td>${item.qty}</td>
                        <td>${fmt(item.price)}</td>
                        <td>${fmt(item.price * item.qty)}</td>
                        <td><button class="btn-danger btn-sm" onclick="removeFromCart('${item.id}')">√ó</button></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <h5 class="text-end mt-3">Total: ${fmt(total)}</h5>
    `;
}

document.getElementById('payType').addEventListener('change', (e) => {
    const isCredit = e.target.value === 'Credit';
    document.getElementById('custName').style.display = isCredit ? 'block' : 'none';
    document.getElementById('custPhone').style.display = isCredit ? 'block' : 'none';
});

document.getElementById('btnSaveSale').addEventListener('click', async () => {
    if (cart.length === 0) {
        Swal.fire({icon: 'warning', title: 'Cart is empty'});
        return;
    }
    
    const paymentType = document.getElementById('payType').value;
    const customerName = document.getElementById('custName').value.trim();
    const customerPhone = document.getElementById('custPhone').value.trim();
    
    if (paymentType === 'Credit' && (!customerName || !customerPhone)) {
        Swal.fire({icon: 'warning', title: 'Enter customer details for credit'});
        return;
    }
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    const products = load(K_PROD);
    const sales = load(K_SALES);
    const patients = load(K_PATIENTS);
    
    for (let item of cart) {
        const prod = products.find(p => p.id === item.id);
        if (!prod || prod.qty < item.qty) {
            Swal.fire({icon: 'error', title: 'Stock error', text: `Not enough stock for ${item.name}`});
            return;
        }
    }
    
    cart.forEach(item => {
        const prod = products.find(p => p.id === item.id);
        prod.qty -= item.qty;
    });
    
    const saleId = uid('INV');
    const sale = {
        id: saleId,
        date: nowISO(),
        total: total,
        payment: paymentType,
        user: currentUser.username,
        lines: cart.map(item => ({
            id: item.id,
            name: item.name,
            qty: item.qty,
            price: item.price,
            cost: item.cost
        })),
        returned: false
    };
    
    if (paymentType === 'Credit') {
        sale.customer = customerName;
        sale.phone = customerPhone;
        let patient = patients.find(p => p.phone === customerPhone);
        if (!patient) {
            patient = {
                id: uid('PAT'),
                name: customerName,
                phone: customerPhone,
                balance: 0
            };
            patients.push(patient);
        }
        patient.balance += total;
        save(K_PATIENTS, patients);
    }
    
    sales.push(sale);
    
    if (save(K_PROD, products) && save(K_SALES, sales)) {
        printReceipt(sale);
        Swal.fire({icon: 'success', title: 'Sale completed', text: `Receipt: ${saleId}`, timer: 2000});
        cart = [];
        renderPOS();
        logAudit('create', 'sale', saleId, `Total: ${fmt(total)}`);
    } else {
        Swal.fire({icon: 'error', title: 'Sale failed'});
    }
});

function printReceipt(sale) {
    const printWindow = window.open('', '_blank');
    const lines = sale.lines.map(l => `
        <tr>
            <td>${escapeHtml(l.name)}</td>
            <td>${l.qty}</td>
            <td>${fmt(l.price)}</td>
            <td>${fmt(l.qty * l.price)}</td>
        </tr>
    `).join('');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt ${sale.id}</title>
            <style>
                body { font-family: monospace; max-width: 300px; margin: 20px auto; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
                .footer { text-align: center; margin-top: 20px; font-size: 12px; }
                .info { margin-bottom: 10px; }
                @media print { button { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>PHARMACY</h2>
                <p>${new Date(sale.date).toLocaleString()}</p>
            </div>
            <div class="info">
                <p><strong>Receipt:</strong> ${sale.id}</p>
                ${sale.customer ? `<p><strong>Customer:</strong> ${escapeHtml(sale.customer)}</p>` : ''}
                ${sale.phone ? `<p><strong>Phone:</strong> ${escapeHtml(sale.phone)}</p>` : ''}
                <p><strong>Cashier:</strong> ${sale.user}</p>
            </div>
            <table width="100%" style="border-collapse: collapse;">
                <tr style="border-bottom: 2px solid #000;"><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>
                ${lines}
                <tr style="border-top: 2px solid #000;">
                    <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                    <td style="text-align: right;"><strong>${fmt(sale.total)}</strong></td>
                </tr>
            </table>
            <div class="footer">
                <p><strong>Payment:</strong> ${sale.payment}</p>
                <p>Thank you for your business!</p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250);
}

// ==================== PRODUCTS (Admin Only) ====================
function renderProducts() {
    if (currentUser.role !== 'admin') return;
    
    document.getElementById('editProductId').value = '';
    document.getElementById('pName').value = '';
    document.getElementById('pPrice').value = '';
    document.getElementById('pCost').value = '';
    document.getElementById('pQty').value = '';
    document.getElementById('pLow').value = '5';
    document.getElementById('pExpiry').value = '';
    document.getElementById('filterProd').value = '';
    renderProductsTable();
}

function renderProductsTable(filtered = null) {
    if (currentUser.role !== 'admin') return;
    
    const products = filtered || load(K_PROD);
    const tbody = document.getElementById('productsTable');
    tbody.innerHTML = '';
    
    const frag = document.createDocumentFragment();
    products.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(p.name)}</td>
            <td>${fmt(p.price)}</td>
            <td>${fmt(p.cost)}</td>
            <td>${p.qty}</td>
            <td>${p.low}</td>
            <td>${new Date(p.expiry).toLocaleDateString()}</td>
            <td>
                <button class="btn-accent btn-sm" onclick="editProduct('${p.id}')">Edit</button>
                <button class="btn-danger btn-sm" onclick="deleteProduct('${p.id}')">Delete</button>
            </td>
        `;
        frag.appendChild(tr);
    });
    
    tbody.appendChild(frag);
}

document.getElementById('productForm').addEventListener('submit', (e) => {
    if (currentUser.role !== 'admin') return;
    
    e.preventDefault();
    
    const id = document.getElementById('editProductId').value;
    const name = document.getElementById('pName').value.trim();
    const price = parseFloat(document.getElementById('pPrice').value);
    const cost = parseFloat(document.getElementById('pCost').value);
    const qty = parseInt(document.getElementById('pQty').value);
    const low = parseInt(document.getElementById('pLow').value);
    const expiry = document.getElementById('pExpiry').value;
    
    if (!name || isNaN(price) || isNaN(cost) || isNaN(qty) || isNaN(low)) {
        Swal.fire({icon: 'warning', title: 'Please fill all fields correctly'});
        return;
    }
    
    const products = load(K_PROD);
    
    if (id) {
        const index = products.findIndex(p => p.id === id);
        if (index !== -1) {
            products[index] = {...products[index], name, price, cost, qty, low, expiry};
            logAudit('update', 'product', id);
        }
    } else {
        products.push({
            id: uid('PROD'),
            name,
            price,
            cost,
            qty,
            low,
            expiry,
            created: nowISO()
        });
        logAudit('create', 'product', null, name);
    }
    
    if (save(K_PROD, products)) {
        Swal.fire({icon: 'success', title: 'Product saved', timer: 1500});
        renderProducts();
    }
});

function editProduct(id) {
    if (currentUser.role !== 'admin') return;
    
    const products = load(K_PROD);
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    document.getElementById('editProductId').value = product.id;
    document.getElementById('pName').value = product.name;
    document.getElementById('pPrice').value = product.price;
    document.getElementById('pCost').value = product.cost;
    document.getElementById('pQty').value = product.qty;
    document.getElementById('pLow').value = product.low;
    document.getElementById('pExpiry').value = product.expiry;
}

function deleteProduct(id) {
    if (currentUser.role !== 'admin') return;
    
    Swal.fire({
        title: 'Delete product?',
        text: 'This cannot be undone.',
        icon: 'warning',
        showCancelButton: true
    }).then(result => {
        if (result.isConfirmed) {
            let products = load(K_PROD);
            products = products.filter(p => p.id !== id);
            if (save(K_PROD, products)) {
                Swal.fire({icon: 'success', title: 'Product deleted', timer: 1500});
                renderProducts();
                logAudit('delete', 'product', id);
            }
        }
    });
}

document.getElementById('filterProd').addEventListener('input', (e) => {
    if (currentUser.role !== 'admin') return;
    
    const search = e.target.value.toLowerCase();
    const products = load(K_PROD);
    const filtered = products.filter(p => p.name.toLowerCase().includes(search));
    renderProductsTable(filtered);
});

// ==================== REPORTS (Cashier & Admin) ====================
document.getElementById('reportRange').addEventListener('change', handleReportRangeChange);
document.getElementById('rFrom').addEventListener('change', renderReports);
document.getElementById('rTo').addEventListener('change', renderReports);

function handleReportRangeChange() {
    const val = document.getElementById('reportRange').value;
    document.getElementById('rFrom').style.display = val === 'custom' ? 'inline-block' : 'none';
    document.getElementById('rTo').style.display = val === 'custom' ? 'inline-block' : 'none';
    renderReports();
}

async function renderReports() {
    const range = document.getElementById('reportRange').value;
    let from = null, to = null;
    
    if (range === 'today') {
        from = new Date(); from.setHours(0,0,0,0);
        to = new Date(); to.setHours(23,59,59,999);
    } else if (range === 'week') {
        from = new Date(); from.setDate(from.getDate() - 7);
        to = new Date();
    } else if (range === 'month') {
        from = new Date(); from.setDate(1);
        to = new Date();
    } else if (range === 'custom') {
        const f = document.getElementById('rFrom').value;
        const t = document.getElementById('rTo').value;
        if (f) { from = new Date(f); from.setHours(0,0,0,0); }
        if (t) { to = new Date(t); to.setHours(23,59,59,999); }
    }
    
    const sales = load(K_SALES).filter(s => {
        if (s.returned) return false;
        if (currentUser.role === 'cashier' && s.user !== currentUser.username) return false;
        const d = new Date(s.date);
        if (from && d < from) return false;
        if (to && d > to) return false;
        return true;
    });
    
    document.getElementById('repTotal').textContent = fmt(sales.reduce((a, b) => a + b.total, 0));
    
    const items = {};
    sales.forEach(s => s.lines.forEach(l => items[l.name] = (items[l.name] || 0) + l.qty));
    
    const repItems = document.getElementById('repItems');
    repItems.innerHTML = '';
    
    if (Object.keys(items).length === 0) {
        repItems.innerHTML = '<p class="text-muted">No items sold in this period.</p>';
    } else {
        const ul = document.createElement('ul');
        ul.className = 'list-group';
        Object.entries(items).sort((a, b) => b[1] - a[1]).forEach(([n, q]) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between';
            li.innerHTML = `${escapeHtml(n)}<span class="badge bg-primary rounded-pill">${q}</span>`;
            ul.appendChild(li);
        });
        repItems.appendChild(ul);
    }
    
    const recent = load(K_SALES).slice().reverse().filter(s => currentUser.role !== 'cashier' || s.user === currentUser.username).slice(0, 50);
    const tbl = document.getElementById('recentSalesTbl');
    tbl.innerHTML = '';
    
    const frag = document.createDocumentFragment();
    recent.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = s.returned ? 'table-warning' : '';
        tr.innerHTML = `<td>${s.id}</td><td>${new Date(s.date).toLocaleString()}</td><td>${fmt(s.total)}</td><td>${s.payment}</td><td>${s.user}</td>`;
        frag.appendChild(tr);
    });
    tbl.appendChild(frag);
    
    // Hide credit accounts section for cashier
    if (currentUser.role === 'admin') {
        const creditList = document.getElementById('creditList');
        const patients = load(K_PATIENTS).filter(p => p.balance > 0);
        creditList.innerHTML = '';
        
        if (patients.length === 0) {
            creditList.innerHTML = '<p class="text-muted">No active credit accounts.</p>';
        } else {
            const frag = document.createDocumentFragment();
            patients.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card-modern mb-2';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(p.name)}</strong><br>
                            <small class="text-muted">${escapeHtml(p.phone)}</small>
                        </div>
                        <h5 class="text-warning">${fmt(p.balance)}</h5>
                    </div>
                `;
                frag.appendChild(div);
            });
            creditList.appendChild(frag);
        }
    }
}

// ==================== RETURNS (Admin Only) ====================
document.getElementById('processReturnBtn').addEventListener('click', () => {
    if (currentUser.role !== 'admin') return;
    
    const orderId = document.getElementById('returnOrderId').value.trim();
    if (!orderId) {
        Swal.fire({icon: 'warning', title: 'Enter Order ID'});
        return;
    }
    processReturn(orderId);
});

function renderReturnsHistory() {
    if (currentUser.role !== 'admin') return;
    
    const returns = load(K_RETURNS);
    const list = document.getElementById('returnsList');
    list.innerHTML = '';
    
    if (returns.length === 0) {
        list.innerHTML = '<p class="text-muted">No returns recorded yet.</p>';
        return;
    }
    
    const frag = document.createDocumentFragment();
    returns.slice().reverse().forEach(r => {
        const div = document.createElement('div');
        div.className = 'card-modern mb-2';
        div.innerHTML = `
            <div class="d-flex justify-content-between">
                <div><b>${r.orderId}</b><br><small>${new Date(r.date).toLocaleString()}</small></div>
                <span class="text-success">‚úì Returned</span>
            </div>
        `;
        frag.appendChild(div);
    });
    list.appendChild(frag);
}

function processReturn(orderId) {
    if (currentUser.role !== 'admin') {
        Swal.fire({icon: 'error', title: 'Access denied', text: 'Admin only.'});
        return;
    }
    
    const sales = load(K_SALES);
    const saleIndex = sales.findIndex(s => s.id === orderId);
    
    if (saleIndex === -1) {
        Swal.fire({icon: 'error', title: 'Order not found'});
        return;
    }
    
    const sale = sales[saleIndex];
    if (sale.returned) {
        Swal.fire({icon: 'info', title: 'Already returned'});
        return;
    }
    
    if ((Date.now() - new Date(sale.date).getTime()) / 36e5 > 24) {
        Swal.fire({icon: 'error', title: 'Return expired', text: 'Returns only allowed within 24 hours.'});
        return;
    }
    
    Swal.fire({
        title: 'Process return?',
        text: `Return ${sale.lines.length} item(s) from order ${orderId}?`,
        icon: 'question',
        showCancelButton: true
    }).then(result => {
        if (result.isConfirmed) {
            let products = load(K_PROD);
            sale.lines.forEach(line => {
                const prod = products.find(p => p.id === line.id);
                if (prod) prod.qty += line.qty;
            });
            
            sales[saleIndex].returned = true;
            const returns = load(K_RETURNS);
            returns.push({id: uid('r'), orderId: sale.id, date: nowISO()});
            
            if (save(K_PROD, products) && save(K_SALES, sales) && save(K_RETURNS, returns)) {
                Swal.fire({icon: 'success', title: 'Return processed', timer: 1500});
                document.getElementById('returnOrderId').value = '';
                document.getElementById('returnResult').innerHTML = `<div class="alert alert-success">Return processed for ${orderId}</div>`;
                updateAll();
                renderReturnsHistory();
                logAudit('return', 'sale', orderId);
            }
        }
    });
}

// ==================== USERS (Admin Only) ====================
document.getElementById('userForm').addEventListener('submit', async (e) => {
    if (currentUser.role !== 'admin') return;
    
    e.preventDefault();
    
    const username = document.getElementById('uName').value.trim();
    const password = document.getElementById('uPass').value;
    const role = document.getElementById('uRole').value;
    
    if (!username || !password || password.length < 4) {
        Swal.fire({icon: 'warning', title: 'Invalid input', text: 'Password must be at least 4 characters'});
        return;
    }
    
    if (username.length > 50) {
        Swal.fire({icon: 'warning', title: 'Username too long'});
        return;
    }
    
    let users = load(K_USERS);
    if (users.find(u => u.username === username)) {
        Swal.fire({icon: 'warning', title: 'User already exists'});
        return;
    }
    
    users.push({
        username,
        password: await hashPassword(password),
        role
    });
    
    if (save(K_USERS, users)) {
        Swal.fire({icon: 'success', title: 'User added', timer: 1500});
        document.getElementById('userForm').reset();
        renderUsers();
        logAudit('create', 'user', username);
    }
});

function renderUsers() {
    if (currentUser.role !== 'admin') return;
    
    const tbody = document.getElementById('usersTable');
    tbody.innerHTML = '';
    
    const users = load(K_USERS);
    const frag = document.createDocumentFragment();
    
    users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(u.username)}</td>
            <td>${u.role}</td>
            <td>
                ${u.username !== 'admin' ? 
                    `<button class="btn-danger btn-sm" onclick="deleteUser('${u.username}')">Delete</button>` : 
                    `<small>Protected</small>`
                }
            </td>
        `;
        frag.appendChild(tr);
    });
    
    tbody.appendChild(frag);
}

function deleteUser(username) {
    if (currentUser.role !== 'admin') return;
    
    if (username === 'admin') {
        Swal.fire({icon: 'error', title: 'Cannot delete admin'});
        return;
    }
    
    Swal.fire({
        title: 'Delete user?',
        text: 'This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true
    }).then(result => {
        if (result.isConfirmed) {
            let users = load(K_USERS);
            users = users.filter(u => u.username !== username);
            if (save(K_USERS, users)) {
                Swal.fire({icon: 'success', title: 'User deleted', timer: 1500});
                renderUsers();
                logAudit('delete', 'user', username);
            }
        }
    });
}

// ==================== CREDIT (Admin Only) ====================
function renderCreditView() {
    if (currentUser.role !== 'admin') return;
    
    document.getElementById('searchCustomer').value = '';
    document.getElementById('paymentAmount').value = '';
    document.getElementById('paymentNote').value = '';
    document.getElementById('paymentResult').innerHTML = '';
    renderCreditAccounts();
}

function renderCreditAccounts() {
    if (currentUser.role !== 'admin') return;
    
    const patients = load(K_PATIENTS);
    const list = document.getElementById('creditAccountsList');
    
    const activePatients = patients.filter(p => p.balance > 0);
    list.innerHTML = '';
    
    if (activePatients.length === 0) {
        list.innerHTML = '<p class="text-muted">No credit customers.</p>';
        return;
    }
    
    const frag = document.createDocumentFragment();
    activePatients.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card-modern mb-2';
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${escapeHtml(p.name)}</strong><br>
                    <small class="text-muted">${escapeHtml(p.phone)}</small><br>
                    <small class="text-muted">ID: ${p.id}</small>
                </div>
                <h5 class="text-warning">${fmt(p.balance)}</h5>
            </div>
        `;
        frag.appendChild(div);
    });
    
    list.appendChild(frag);
}

document.getElementById('creditPaymentForm').addEventListener('submit', async (e) => {
    if (currentUser.role !== 'admin') return;
    
    e.preventDefault();
    
    const search = document.getElementById('searchCustomer').value.trim();
    const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
    const note = document.getElementById('paymentNote').value.trim();
    
    if (!search || amount <= 0) {
        Swal.fire({icon: 'warning', title: 'Invalid input'});
        return;
    }
    
    let patients = load(K_PATIENTS);
    const patient = patients.find(p => 
        p.name.toLowerCase().includes(search.toLowerCase()) || 
        p.phone.includes(search)
    );
    
    if (!patient) {
        Swal.fire({icon: 'error', title: 'Customer not found'});
        return;
    }
    
    if (amount > patient.balance) {
        Swal.fire({icon: 'error', title: 'Invalid amount', text: `Customer only owes ${fmt(patient.balance)}`});
        return;
    }
    
    patient.balance = Math.max(0, patient.balance - amount);
    
    const payments = load(K_PAYMENTS);
    payments.push({
        id: uid('PAY'),
        customerId: patient.id,
        patientName: patient.name,
        amount,
        note,
        date: nowISO(),
        user: currentUser.username
    });
    
    if (save(K_PATIENTS, patients) && save(K_PAYMENTS, payments)) {
        Swal.fire({icon: 'success', title: 'Payment recorded', text: `${fmt(amount)} deducted from ${patient.name}`, timer: 2000});
        document.getElementById('creditPaymentForm').reset();
        renderCreditAccounts();
        renderReports();
        document.getElementById('paymentResult').innerHTML = `<div class="alert alert-success">Payment recorded successfully!</div>`;
        logAudit('payment', 'credit', patient.id, `Amount: ${fmt(amount)}`);
    } else {
        Swal.fire({icon: 'error', title: 'Save failed'});
    }
});

// ==================== AUDIT LOG ====================
function logAudit(action, entity, entityId, details = '') {
    const audit = load(K_AUDIT);
    audit.push({
        id: uid('AUD'),
        timestamp: nowISO(),
        user: currentUser.username,
        action,
        entity,
        entityId,
        details
    });
    if (audit.length > 1000) audit.splice(0, audit.length - 1000);
    save(K_AUDIT, audit);
}

// ==================== UPDATE ALL ====================
function updateAll() {
    if (currentUser.role === 'admin') {
        renderDashboard();
    }
}

// ==================== INITIALIZATION ====================
async function initApp() {
    await initDefaultData();
    await checkSession();
}

// Start the application
initApp();
</script>

</body>
</html>
